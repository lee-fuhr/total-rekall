<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Total Recall ‚Äî Memory Intelligence</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;1,9..144,300;1,9..144,400&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<style>
/* =====================================================================
   Design system ‚Äî Total Recall
   Palette: deep obsidian + warm amber + bone white
   ===================================================================== */
:root {
  --bg:           #08100d;
  --bg-2:         #0e1a15;
  --bg-3:         #162419;
  --bg-card:      #111c17;
  --bg-hover:     #1a2a22;
  --border:       #1e3028;
  --border-bright:#2a4035;

  --amber:        #d4862a;
  --amber-bright: #e8a030;
  --amber-dim:    #9a6020;
  --amber-glow:   rgba(212,134,42,0.15);

  --green:        #3db87a;
  --green-dim:    #1e5c3d;
  --blue:         #3a8ab8;
  --rose:         #c0516a;

  --text-1:       #e8e2d6;
  --text-2:       #9aaa9e;
  --text-3:       #5a7060;
  --text-amber:   #d4862a;

  --font-display: 'Fraunces', Georgia, serif;
  --font-body:    'IBM Plex Sans', sans-serif;
  --font-mono:    'IBM Plex Mono', monospace;

  --radius:       6px;
  --radius-lg:    12px;

  --shadow-card:  0 1px 3px rgba(0,0,0,0.4), 0 0 0 1px var(--border);
  --shadow-glow:  0 0 24px rgba(212,134,42,0.1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text-1);
  font-family: var(--font-body);
  font-size: 14px;
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Subtle noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 1000;
  opacity: 0.4;
}

/* =====================================================================
   Layout
   ===================================================================== */
.shell {
  display: grid;
  grid-template-columns: 220px 1fr;
  grid-template-rows: 56px 1fr;
  min-height: 100vh;
}

/* =====================================================================
   Topbar
   ===================================================================== */
.topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 24px;
  padding: 0 24px;
  background: var(--bg-2);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}

.wordmark {
  display: flex;
  align-items: baseline;
  gap: 2px;
  text-decoration: none;
  flex-shrink: 0;
}

.wordmark-m {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 600;
  color: var(--amber-bright);
  letter-spacing: -0.02em;
  font-style: italic;
}

.wordmark-rest {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 300;
  color: var(--text-1);
  letter-spacing: -0.01em;
}

.topbar-sep {
  width: 1px;
  height: 20px;
  background: var(--border-bright);
}

.search-wrap {
  flex: 1;
  max-width: 460px;
  position: relative;
}

.search-wrap svg {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-3);
  width: 15px;
  height: 15px;
}

#search-input {
  width: 100%;
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-1);
  font-family: var(--font-body);
  font-size: 13px;
  padding: 8px 12px 8px 36px;
  outline: none;
  transition: border-color 0.15s;
}

#search-input:focus {
  border-color: var(--amber-dim);
}

#search-input::placeholder { color: var(--text-3); }

.topbar-actions {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}

.project-badge {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-3);
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 3px 8px;
  cursor: pointer;
  transition: border-color 0.12s, color 0.12s;
}
.project-badge:hover {
  border-color: var(--amber-dim);
  color: var(--amber);
}

#project-label {
  color: var(--amber);
}

.refresh-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
}

.refresh-updated {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-3);
}

.btn-refresh {
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-3);
  width: 28px;
  height: 28px;
  padding: 0;
  cursor: pointer;
  transition: border-color 0.15s, color 0.15s;
}

.btn-refresh:hover {
  border-color: var(--amber-dim);
  color: var(--amber);
}

.btn-refresh svg { width: 13px; height: 13px; }

/* =====================================================================
   Tooltip system
   ===================================================================== */
[data-tooltip] {
  position: relative;
}
[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-3);
  border: 1px solid var(--border-bright);
  color: var(--text-1);
  font-family: var(--font-body);
  font-size: 11px;
  line-height: 1.5;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: normal;
  width: max-content;
  max-width: 240px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  z-index: 9999;
  text-align: left;
}
[data-tooltip]:hover::after {
  opacity: 1;
}

/* =====================================================================
   Sidebar
   ===================================================================== */
.sidebar {
  background: var(--bg-2);
  border-right: 1px solid var(--border);
  padding: 20px 0;
  position: sticky;
  top: 56px;
  height: calc(100vh - 56px);
  overflow-y: auto;
}

.nav-section {
  margin-bottom: 8px;
}

.nav-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.1em;
  color: var(--text-3);
  text-transform: uppercase;
  padding: 8px 20px 4px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 20px;
  color: var(--text-2);
  text-decoration: none;
  font-size: 13px;
  cursor: pointer;
  border-left: 2px solid transparent;
  transition: all 0.12s;
  user-select: none;
}

.nav-item svg { width: 15px; height: 15px; flex-shrink: 0; opacity: 0.7; }

.nav-item:hover {
  color: var(--text-1);
  background: var(--bg-hover);
}

.nav-item.active {
  color: var(--amber);
  border-left-color: var(--amber);
  background: var(--amber-glow);
}

.nav-item.active svg { opacity: 1; }

.sidebar-footer {
  margin-top: auto;
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-3);
}

/* =====================================================================
   Main content
   ===================================================================== */
.main {
  overflow-y: auto;
  padding: 28px 32px;
}

/* View panels */
.view { display: none; }
.view.active { display: block; animation: fadein 0.2s ease; }

@keyframes fadein {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* =====================================================================
   Page headers
   ===================================================================== */
.page-header {
  margin-bottom: 28px;
}

.page-title {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 300;
  color: var(--text-1);
  letter-spacing: -0.02em;
  line-height: 1.2;
}

.page-title em {
  font-style: italic;
  color: var(--amber);
}

.page-sub {
  margin-top: 6px;
  font-size: 13px;
  color: var(--text-2);
}

/* =====================================================================
   Stat cards
   ===================================================================== */
.stat-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
  gap: 14px;
  margin-bottom: 28px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.15s;
}

.stat-card:hover { border-color: var(--border-bright); }
.stat-card[data-action] { cursor: pointer; }
.stat-card[data-action]:hover { border-color: var(--amber); }

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--amber-dim), transparent);
  opacity: 0.5;
}

.stat-label {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-3);
  margin-bottom: 8px;
}

.stat-value {
  font-family: var(--font-display);
  font-size: 36px;
  font-weight: 600;
  color: var(--text-1);
  line-height: 1;
  letter-spacing: -0.03em;
}

.stat-value.amber { color: var(--amber-bright); }
.stat-value.green { color: var(--green); }

.stat-sub {
  margin-top: 6px;
  font-size: 11px;
  color: var(--text-3);
  font-family: var(--font-mono);
}

/* =====================================================================
   Grade bar (A/B/C/D distribution)
   ===================================================================== */
.grade-bar {
  display: flex;
  height: 8px;
  border-radius: 4px;
  overflow: hidden;
  gap: 2px;
  margin-top: 12px;
}

.grade-seg {
  border-radius: 2px;
  transition: flex 0.6s ease;
  cursor: default;
}

.grade-seg.A { background: var(--green); }
.grade-seg.B { background: var(--amber); }
.grade-seg.C { background: #6b7c72; }
.grade-seg.D { background: var(--rose); }

.grade-legend {
  display: flex;
  gap: 14px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.grade-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
}

.grade-dot {
  width: 8px; height: 8px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* =====================================================================
   Section headings
   ===================================================================== */
.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}

.section-title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 400;
  color: var(--text-1);
  letter-spacing: -0.01em;
}

.section-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-3);
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 2px 7px;
}

/* =====================================================================
   Memory cards
   ===================================================================== */
.memory-filters {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-select {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-2);
  font-family: var(--font-body);
  font-size: 12px;
  padding: 6px 10px;
  outline: none;
  cursor: pointer;
  transition: border-color 0.15s;
}

.filter-select:focus { border-color: var(--amber-dim); }

.filter-tag {
  display: flex;
  align-items: center;
  gap: 5px;
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  color: var(--text-2);
  padding: 4px 10px;
  cursor: pointer;
  transition: all 0.12s;
  font-family: var(--font-mono);
}

.filter-tag:hover, .filter-tag.active {
  border-color: var(--amber-dim);
  color: var(--amber);
  background: var(--amber-glow);
}

.memory-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.memory-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  cursor: pointer;
  transition: border-color 0.12s, background 0.12s;
  position: relative;
}

.memory-card:hover {
  border-color: var(--border-bright);
  background: var(--bg-hover);
}

/* Freshness indicators ‚Äî subtle opacity fade for aging memories */
.memory-card.stale-1 { opacity: 0.85; }  /* 30-89 days */
.memory-card.stale-2 { opacity: 0.65; }  /* 90-179 days */
.memory-card.stale-3 { opacity: 0.50; }  /* 180+ days */

.freshness-pip {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-right: 4px;
  vertical-align: middle;
}

.freshness-pip.fresh    { background: #4ade80; }  /* <7 days */
.freshness-pip.recent   { background: var(--amber); }  /* 7-29 days */
.freshness-pip.aging    { background: #f59e0b; }  /* 30-89 days */
.freshness-pip.stale    { background: var(--rose); }   /* 90+ days */

.stale-toggle {
  font-size: 12px;
  padding: 5px 10px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-3);
  color: var(--text-2);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}

.stale-toggle:hover { border-color: var(--amber-dim); }

.stale-toggle.active {
  border-color: var(--rose);
  color: var(--rose);
  background: color-mix(in srgb, var(--rose) 10%, var(--bg-3));
}

.memory-card-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 8px;
}

.memory-preview {
  font-size: 13px;
  color: var(--text-1);
  line-height: 1.5;
  flex: 1;
}

.memory-preview mark {
  background: color-mix(in srgb, var(--amber) 30%, transparent);
  color: inherit;
  border-radius: 2px;
  padding: 0 1px;
}

.match-reasons {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.match-reason-tag {
  font-size: 10px;
  font-weight: 500;
  color: var(--amber);
  background: color-mix(in srgb, var(--amber) 12%, transparent);
  border: 1px solid color-mix(in srgb, var(--amber) 30%, transparent);
  border-radius: 3px;
  padding: 1px 5px;
  letter-spacing: 0.02em;
}

.importance-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}

.imp-pip {
  width: 8px; height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.grade-A .imp-pip { background: var(--green); box-shadow: 0 0 6px var(--green); }
.grade-B .imp-pip { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
.grade-C .imp-pip { background: #6b7c72; }
.grade-D .imp-pip { background: var(--rose); }

.imp-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 500;
}

.grade-A .imp-label { color: var(--green); }
.grade-B .imp-label { color: var(--amber); }
.grade-C .imp-label { color: var(--text-3); }
.grade-D .imp-label { color: var(--rose); }

.memory-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.mem-tag {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-3);
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 1px 6px;
  cursor: pointer;
  transition: color 0.12s;
}

.mem-tag:hover { color: var(--amber); border-color: var(--amber-dim); }

.mem-domain {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--amber-dim);
}

.mem-date {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-3);
}

.action-pill {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--rose);
  background: rgba(192,81,106,0.1);
  border: 1px solid rgba(192,81,106,0.3);
  border-radius: 3px;
  padding: 1px 6px;
}

.session-filter-chip {
  display: none;
  align-items: center;
  gap: 6px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--amber);
  background: rgba(212,134,42,0.1);
  border: 1px solid rgba(212,134,42,0.3);
  border-radius: 4px;
  padding: 3px 10px;
  margin-bottom: 12px;
}
.session-filter-chip.active { display: flex; }
.session-filter-chip-x {
  cursor: pointer;
  opacity: 0.7;
  font-size: 14px;
  line-height: 1;
  margin-left: 2px;
}
.session-filter-chip-x:hover { opacity: 1; }

.ps-pill {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--blue);
  background: rgba(58,138,184,0.1);
  border: 1px solid rgba(58,138,184,0.3);
  border-radius: 3px;
  padding: 1px 6px;
}

/* Importance bar on left edge */
.memory-card::before {
  content: '';
  position: absolute;
  left: 0; top: 6px; bottom: 6px;
  width: 3px;
  border-radius: 0 2px 2px 0;
  background: var(--border);
  transition: background 0.12s;
}

.grade-A.memory-card::before { background: var(--green); }
.grade-B.memory-card::before { background: var(--amber); }
.grade-C.memory-card::before { background: #3a4a40; }
.grade-D.memory-card::before { background: var(--rose); }

.load-more-btn {
  margin-top: 16px;
  width: 100%;
  background: none;
  border: 1px dashed var(--border);
  border-radius: var(--radius-lg);
  color: var(--text-3);
  font-family: var(--font-body);
  font-size: 13px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.12s;
}

.load-more-btn:hover {
  border-color: var(--amber-dim);
  color: var(--amber);
}

/* =====================================================================
   Sessions view
   ===================================================================== */
.session-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.session-row {
  display: grid;
  grid-template-columns: 160px 1fr 80px 80px 80px;
  gap: 16px;
  align-items: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 16px;
  transition: border-color 0.12s;
  font-size: 13px;
}

.session-row:hover { border-color: var(--border-bright); cursor: pointer; }

.sess-date {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-3);
}

.sess-name {
  color: var(--text-1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sess-stat {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-2);
  text-align: right;
}

.sess-stat.amber { color: var(--amber); }
.sess-stat.green { color: var(--green); }

.session-table-header {
  display: grid;
  grid-template-columns: 160px 1fr 80px 80px 80px;
  gap: 16px;
  padding: 8px 16px;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-3);
  margin-bottom: 4px;
}

.session-table-header > * { text-align: right; }
.session-table-header > :first-child { text-align: left; }
.session-table-header > :nth-child(2) { text-align: left; }

/* =====================================================================
   Knowledge map (tag cloud)
   ===================================================================== */
.tag-cloud {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
}

.tag-bubble {
  font-family: var(--font-mono);
  border-radius: 4px;
  border: 1px solid;
  padding: 4px 10px;
  cursor: pointer;
  transition: all 0.12s;
  white-space: nowrap;
}

.tag-bubble:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* =====================================================================
   Activity heatmap
   ===================================================================== */
.heatmap-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  overflow-x: auto;
}

.heatmap-grid {
  display: flex;
  gap: 3px;
}

.heatmap-col {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.heatmap-cell {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  background: var(--bg-3);
  transition: background 0.2s;
  cursor: default;
  position: relative;
}

.heatmap-cell[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-2);
  border: 1px solid var(--border-bright);
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-1);
  white-space: nowrap;
  z-index: 10;
  pointer-events: none;
}

.heatmap-cell.l1 { background: rgba(212,134,42,0.2); }
.heatmap-cell.l2 { background: rgba(212,134,42,0.45); }
.heatmap-cell.l3 { background: rgba(212,134,42,0.7); }
.heatmap-cell.l4 { background: var(--amber); }

.heatmap-months {
  display: flex;
  gap: 3px;
  margin-bottom: 6px;
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-3);
  letter-spacing: 0.04em;
}

/* =====================================================================
   Two-column layout for overview
   ===================================================================== */
.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}

.col-block {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
}

/* Domain / context bars */
.bar-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.bar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: opacity 0.12s;
}

.bar-item:hover { opacity: 0.8; }

.bar-label {
  font-size: 12px;
  color: var(--text-2);
  width: 160px;
  flex-shrink: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: var(--font-mono);
}

.bar-track {
  flex: 1;
  height: 6px;
  background: var(--bg-3);
  border-radius: 3px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--amber-dim), var(--amber));
  transition: width 0.6s ease;
}

.bar-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-3);
  width: 36px;
  text-align: right;
  flex-shrink: 0;
}

/* =====================================================================
   Loading / empty states
   ===================================================================== */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 80px 20px;
  color: var(--text-3);
  font-family: var(--font-mono);
  font-size: 13px;
}

.spinner {
  width: 32px; height: 32px;
  border: 2px solid var(--border);
  border-top-color: var(--amber);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-3);
  font-size: 13px;
}

/* =====================================================================
   Memory detail modal
   ===================================================================== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  z-index: 500;
  align-items: center;
  justify-content: center;
}

.modal-overlay.open {
  display: flex;
  animation: fadein 0.15s ease;
}

.modal {
  background: var(--bg-2);
  border: 1px solid var(--border-bright);
  border-radius: var(--radius-lg);
  width: min(720px, 90vw);
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 16px 48px rgba(0,0,0,0.5), var(--shadow-glow);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
}

.modal-title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 400;
  color: var(--text-1);
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-3);
  font-size: 20px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: color 0.12s, background 0.12s;
  line-height: 1;
}

.modal-close:hover {
  color: var(--text-1);
  background: var(--bg-3);
}

.modal-body {
  overflow-y: auto;
  padding: 24px;
  flex: 1;
}

.modal-meta-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.modal-meta-item {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
}

.modal-meta-label {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-3);
  margin-bottom: 4px;
}

.modal-meta-value {
  font-size: 13px;
  color: var(--text-1);
}

.modal-body-content {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.7;
  color: var(--text-1);
  white-space: pre-wrap;
  word-wrap: break-word;
}

.modal-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 16px;
}

/* =====================================================================
   Export buttons
   ===================================================================== */
.export-bar {
  display: flex;
  gap: 8px;
  margin-left: auto;
}

.btn-export {
  display: flex;
  align-items: center;
  gap: 5px;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-3);
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 5px 10px;
  cursor: pointer;
  transition: border-color 0.15s, color 0.15s;
}

.btn-export:hover {
  border-color: var(--amber-dim);
  color: var(--amber);
}

/* =====================================================================
   Scrollbar
   ===================================================================== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--amber-dim); }

/* =====================================================================
   Responsive tweaks
   ===================================================================== */
@media (max-width: 900px) {
  .shell { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .two-col { grid-template-columns: 1fr; }
  .session-row { grid-template-columns: 120px 1fr 60px 60px; }
  .session-row > :last-child { display: none; }
  .session-table-header > :last-child { display: none; }
}

/* =====================================================================
   Notification bell + dropdown
   ===================================================================== */
.notif-wrap {
  position: relative;
}

.btn-bell {
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-2);
  width: 34px;
  height: 34px;
  cursor: pointer;
  transition: border-color 0.15s, color 0.15s;
  position: relative;
}

.btn-bell:hover {
  border-color: var(--amber-dim);
  color: var(--amber);
}

.btn-bell svg { width: 16px; height: 16px; }

.notif-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  min-width: 16px;
  height: 16px;
  background: var(--rose);
  color: #fff;
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 500;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
  line-height: 1;
  pointer-events: none;
}

.notif-badge.hidden { display: none; }

.notif-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  width: 380px;
  max-height: 480px;
  background: var(--bg-2);
  border: 1px solid var(--border-bright);
  border-radius: var(--radius-lg);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), var(--shadow-glow);
  z-index: 200;
  overflow: hidden;
}

.notif-dropdown.open { display: flex; flex-direction: column; }

.notif-dropdown-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}
.notif-dropdown-header:hover { background: rgba(255,255,255,0.02); }

.notif-dropdown-title {
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 400;
  color: var(--text-1);
}

.notif-dropdown-title-btn {
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 400;
  color: var(--text-1);
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  transition: color 0.12s;
}
.notif-dropdown-title-btn:hover { color: var(--amber-bright); }

.notif-link {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--amber-dim);
  cursor: pointer;
  border: none;
  background: none;
  transition: color 0.12s;
  padding: 2px 4px;
}

.notif-link:hover { color: var(--amber-bright); }

.notif-dropdown-list {
  overflow-y: auto;
  flex: 1;
  max-height: 400px;
}

.notif-item {
  display: flex;
  gap: 10px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.1s;
  align-items: flex-start;
}

.notif-item:hover { background: var(--bg-hover); }
.notif-item:last-child { border-bottom: none; }

.notif-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 14px;
}

.notif-icon.consolidation { background: rgba(212,134,42,0.15); }
.notif-icon.promotion     { background: rgba(61,184,122,0.15); }
.notif-icon.reinforcement { background: rgba(58,138,184,0.15); }
.notif-icon.contradiction { background: rgba(192,81,106,0.15); }
.notif-icon.default       { background: var(--bg-3); }

.notif-content { flex: 1; min-width: 0; }

.notif-title-text {
  font-size: 12px;
  color: var(--text-1);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.notif-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-3);
  margin-top: 2px;
}

.notif-dismiss-btn {
  background: none;
  border: none;
  color: var(--text-3);
  cursor: pointer;
  font-size: 14px;
  padding: 2px 4px;
  line-height: 1;
  opacity: 0;
  transition: opacity 0.12s, color 0.12s;
  flex-shrink: 0;
  align-self: center;
}

.notif-item:hover .notif-dismiss-btn { opacity: 1; }
.notif-dismiss-btn:hover { color: var(--rose); }

.notif-dropdown-footer {
  padding: 10px 16px;
  border-top: 1px solid var(--border);
  text-align: center;
}

.notif-empty {
  padding: 32px 16px;
  text-align: center;
  font-size: 12px;
  color: var(--text-3);
  font-family: var(--font-mono);
}

/* =====================================================================
   Activity view
   ===================================================================== */
.activity-filters {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.activity-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.activity-card {
  display: flex;
  gap: 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  transition: border-color 0.12s;
}

.activity-card:hover { border-color: var(--border-bright); }
.activity-card.dismissed { opacity: 0.45; }

.activity-card-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
}

.activity-card-body { flex: 1; min-width: 0; }

.activity-card-title {
  font-size: 13px;
  color: var(--text-1);
  margin-bottom: 4px;
}

.activity-card-message {
  font-size: 12px;
  color: var(--text-2);
  margin-bottom: 6px;
}

.activity-card-meta {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.activity-card-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-3);
}

.activity-card-type {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 1px 6px;
  border-radius: 3px;
  border: 1px solid var(--border);
  color: var(--text-3);
}

.activity-card-actions {
  display: flex;
  align-items: center;
  flex-shrink: 0;
  align-self: flex-start;
}

.btn-dismiss-activity {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-3);
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 4px 8px;
  cursor: pointer;
  transition: all 0.12s;
}

.btn-dismiss-activity:hover {
  border-color: var(--amber-dim);
  color: var(--amber);
}

/* Activity card memory content */
.activity-content-section {
  margin-top: 10px;
}

.activity-content-label {
  font-family: var(--font-mono);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-3);
  display: block;
  margin-bottom: 4px;
}

.activity-content-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.activity-content-list li {
  font-size: 12px;
  color: var(--text-2);
  line-height: 1.5;
  padding-left: 14px;
  position: relative;
}

.activity-content-list li::before {
  content: '¬∑';
  position: absolute;
  left: 3px;
  color: var(--amber-dim);
  font-weight: 600;
}

.activity-content-more {
  color: var(--text-3) !important;
  font-family: var(--font-mono);
  font-size: 10px !important;
}

.activity-content-more::before {
  display: none !important;
}

.btn-expand-more {
  background: none;
  border: none;
  padding: 0;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--amber-dim);
  cursor: pointer;
  transition: color 0.12s;
}
.btn-expand-more:hover { color: var(--amber-bright); }

/* bar-row for knowledge map (click-to-filter) */
.bar-row {
  display: grid;
  grid-template-columns: 140px 1fr 48px;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
  transition: opacity 0.12s;
}
.bar-row:hover { opacity: 1 !important; }
.bar-row .bar-label { font-size: 12px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bar-row .bar-count { font-family: var(--font-mono); font-size: 11px; color: var(--text-3); text-align: right; }
</style>
</head>
<body>

<div class="shell">

  <!-- ================================================================
       Topbar
       ================================================================ -->
  <header class="topbar">
    <a class="wordmark" href="#">
      <span class="wordmark-m">T</span>
      <span class="wordmark-rest">otal Recall</span>
    </a>

    <div class="topbar-sep"></div>

    <div class="search-wrap">
      <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="9" r="6"/><path d="M15 15l3 3"/>
      </svg>
      <input id="search-input" type="text" placeholder="Search memories‚Ä¶" autocomplete="off">
    </div>

    <div class="topbar-actions">
      <span class="project-badge" data-tooltip="Current memory scope. Click to switch projects.">project: <span id="project-label">‚Äî</span></span>

      <div class="notif-wrap" id="notif-wrap">
        <button class="btn-bell" id="btn-bell" title="Notifications">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M10 2a5 5 0 0 0-5 5v3l-1.5 2.5h13L15 10V7a5 5 0 0 0-5-5z"/>
            <path d="M8.5 16.5a1.5 1.5 0 0 0 3 0"/>
          </svg>
          <span class="notif-badge hidden" id="notif-badge">0</span>
        </button>
        <div class="notif-dropdown" id="notif-dropdown">
          <div class="notif-dropdown-header">
            <button class="notif-dropdown-title-btn" id="notif-header-link" title="View all activity">Notifications</button>
            <button class="notif-link" id="notif-mark-all-read">Mark all read</button>
          </div>
          <div class="notif-dropdown-list" id="notif-dropdown-list">
            <div class="notif-empty">No new notifications</div>
          </div>
          <div class="notif-dropdown-footer">
            <button class="notif-link" id="notif-view-all">View all activity ‚Üí</button>
          </div>
        </div>
      </div>

      <div class="refresh-wrap">
        <span class="refresh-updated" id="refresh-updated"></span>
        <button class="btn-refresh" id="btn-refresh" title="Refresh data">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 10A7 7 0 1 1 10 3M17 3v7h-7"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- ================================================================
       Sidebar
       ================================================================ -->
  <nav class="sidebar">
    <div class="nav-section">
      <div class="nav-label">Navigate</div>
      <div class="nav-item active" data-view="overview">
        <svg viewBox="0 0 20 20" fill="currentColor"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="11" y="3" width="6" height="6" rx="1"/><rect x="3" y="11" width="6" height="6" rx="1"/><rect x="11" y="11" width="6" height="6" rx="1"/></svg>
        Overview
      </div>
      <div class="nav-item" data-view="memories">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="10" cy="10" r="7"/><path d="M10 7v3l2 2"/></svg>
        Memories
      </div>
      <div class="nav-item" data-view="sessions">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="14" height="12" rx="2"/><path d="M7 8h6M7 12h4"/></svg>
        Sessions
      </div>
      <div class="nav-item" data-view="activity">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M10 2a5 5 0 0 0-5 5v3l-1.5 2.5h13L15 10V7a5 5 0 0 0-5-5z"/>
          <path d="M8.5 16.5a1.5 1.5 0 0 0 3 0"/>
        </svg>
        Activity
        <span class="section-count" id="activity-nav-badge" style="margin-left:auto;display:none;font-family:var(--font-mono);font-size:10px;color:var(--amber)">0</span>
      </div>
      <div class="nav-item" data-view="knowledge">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="10" r="2"/><circle cx="15" cy="5" r="2"/><circle cx="15" cy="15" r="2"/><path d="M7 10h4M13 5.8l-4 3.4M13 14.2l-4-3.4"/></svg>
        Knowledge map
      </div>
    </div>

    <div class="nav-section" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border)">
      <div class="nav-label">Filters</div>
      <div id="domain-nav"></div>
    </div>
  </nav>

  <!-- ================================================================
       Main content
       ================================================================ -->
  <main class="main" id="main-content">

    <!-- Overview -->
    <div class="view active" id="view-overview">
      <div class="page-header">
        <h1 class="page-title">Good morning ‚Äî here's your <em>memory state</em></h1>
        <p class="page-sub" id="overview-sub">Loading‚Ä¶</p>
      </div>

      <div class="stat-row" id="stat-row">
        <div class="loading-state"><div class="spinner"></div></div>
      </div>

      <!-- Grade distribution -->
      <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;margin-bottom:24px" id="grade-card">
        <div class="section-head">
          <span class="section-title">Quality distribution</span>
          <span class="section-count" id="grade-total">‚Äî</span>
        </div>
        <div class="grade-bar" id="grade-bar"></div>
        <div class="grade-legend" id="grade-legend"></div>
      </div>

      <div class="two-col">
        <div class="col-block">
          <div class="section-head">
            <span class="section-title">Knowledge domains</span>
          </div>
          <div class="bar-list" id="domain-bars"></div>
        </div>
        <div class="col-block">
          <div class="section-head">
            <span class="section-title">Context types</span>
          </div>
          <div class="bar-list" id="context-bars"></div>
        </div>
      </div>

      <!-- Session activity heatmap -->
      <div class="section-head" style="margin-bottom:14px">
        <span class="section-title">Session activity</span>
        <span class="section-count" id="heatmap-total">‚Äî</span>
      </div>
      <div class="heatmap-wrap">
        <div class="heatmap-months" id="heatmap-months"></div>
        <div class="heatmap-grid" id="heatmap-grid"></div>
      </div>
    </div>

    <!-- Memories -->
    <div class="view" id="view-memories">
      <div class="page-header">
        <h1 class="page-title"><em>Memory</em> library</h1>
        <p class="page-sub" id="memories-sub">Loading‚Ä¶</p>
      </div>

      <div class="memory-filters">
        <select class="filter-select" id="mem-sort">
          <option value="importance">Sort: importance</option>
          <option value="recency">Sort: newest first</option>
        </select>
        <select class="filter-select" id="mem-domain">
          <option value="">All domains</option>
        </select>
        <div id="mem-tag-filters"></div>
        <button class="stale-toggle" id="stale-toggle" title="Show only memories older than 90 days">Stale (>90d)</button>
        <div class="export-bar">
          <button class="btn-export" id="export-json" title="Export all memories as JSON">
            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 10v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-3"/><path d="M8 2v8M5 7l3 3 3-3"/></svg>
            JSON
          </button>
          <button class="btn-export" id="export-csv" title="Export all memories as CSV">
            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 10v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-3"/><path d="M8 2v8M5 7l3 3 3-3"/></svg>
            CSV
          </button>
        </div>
      </div>

      <div class="session-filter-chip" id="session-filter-chip">
        <span>Filtered by session</span>
        <span class="session-filter-chip-x" id="session-filter-clear" title="Clear session filter">‚úï</span>
      </div>

      <div class="section-head">
        <span class="section-title">Memories</span>
        <span class="section-count" id="mem-count">‚Äî</span>
      </div>

      <div id="memory-list" class="memory-list">
        <div class="loading-state"><div class="spinner"></div></div>
      </div>

      <button class="load-more-btn" id="load-more-btn" style="display:none">
        Load more
      </button>
    </div>

    <!-- Sessions -->
    <div class="view" id="view-sessions">
      <div class="page-header">
        <h1 class="page-title">Session <em>history</em></h1>
        <p class="page-sub" id="sessions-sub">Loading‚Ä¶</p>
      </div>

      <div class="session-table-header">
        <div>Date</div>
        <div>Session name</div>
        <div data-tooltip="Total messages exchanged in this session.">Messages</div>
        <div data-tooltip="Number of tool calls (file reads, bash commands, etc.) made by Claude.">Tools</div>
        <div data-tooltip="Memories extracted and saved to Total Recall at the end of this session. Click a row to see them.">Memories</div>
      </div>
      <div id="session-list" class="session-list">
        <div class="loading-state"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Knowledge map -->
    <div class="view" id="view-knowledge">
      <div class="page-header">
        <h1 class="page-title">Knowledge <em>map</em></h1>
        <p class="page-sub">Topics and domains across all memories</p>
      </div>

      <div class="section-head" style="margin-bottom:14px">
        <span class="section-title">Semantic tags</span>
        <span class="section-count" id="tag-count">‚Äî</span>
      </div>
      <div class="tag-cloud" id="tag-cloud">
        <div class="loading-state"><div class="spinner"></div></div>
      </div>

      <div style="height:24px"></div>

      <div class="section-head" style="margin-bottom:14px">
        <span class="section-title">Domain breakdown</span>
      </div>
      <div class="col-block">
        <div class="bar-list" id="domain-bars-full"></div>
      </div>
    </div>

    <!-- Activity -->
    <div class="view" id="view-activity">
      <div class="page-header">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <h1 class="page-title">System <em>activity</em></h1>
            <p class="page-sub" id="activity-sub">Loading‚Ä¶</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="filter-select" id="activity-type-filter">
              <option value="">All types</option>
              <option value="consolidation_summary">üíæ Session recap</option>
              <option value="reinforcement_detected">üîÅ Reinforced</option>
              <option value="memory_promoted">‚¨ÜÔ∏è Promoted</option>
              <option value="contradiction">‚ö†Ô∏è Contradiction</option>
              <option value="pattern_detected">üîç Pattern</option>
              <option value="quality_issue">üìä Quality</option>
              <option value="expiring_memory">‚è∞ Expiring</option>
              <option value="stale_memory">üí§ Stale</option>
            </select>
            <button class="btn-export" id="activity-dismiss-all">Dismiss all</button>
          </div>
        </div>
      </div>

      <div class="section-head">
        <span class="section-title">Recent activity</span>
        <span class="section-count" id="activity-count">‚Äî</span>
      </div>

      <div id="activity-list" class="activity-list">
        <div class="loading-state"><div class="spinner"></div></div>
      </div>

      <button class="load-more-btn" id="activity-load-more" style="display:none">
        Load more
      </button>
    </div>

  </main><!-- /main -->
</div><!-- /shell -->

<!-- Memory detail modal -->
<div class="modal-overlay" id="memory-modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">Memory detail</span>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-body" id="modal-body">
      <div class="loading-state"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<script>
/* ===================================================================
   Total Recall Dashboard ‚Äî client-side JS
   =================================================================== */

const state = {
  stats: null,
  memories: null,
  sessions: null,
  currentView: 'overview',
  memFilter: { sort: 'importance', domain: '', tag: '', q: '', session_id: '', action_required: '', min_importance: '', stale_days: '' },
  memOffset: 0,
  MEM_PAGE: 40,
  activeTag: null,
};

// -----------------------------------------------------------------------
// Navigation
// -----------------------------------------------------------------------

document.querySelectorAll('.nav-item[data-view]').forEach(el => {
  el.addEventListener('click', () => {
    const view = el.dataset.view;
    if (view === 'memories') {
      // Clear session filter so Memories nav always shows full list
      state.memFilter.session_id = '';
    }
    switchView(view);
  });
});

function switchView(view) {
  document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
  document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');
  document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
  document.getElementById(`view-${view}`)?.classList.add('active');
  state.currentView = view;

  if (view === 'memories' && !state.memories) loadMemories();
  if (view === 'sessions' && !state.sessions) loadSessions();
  if (view === 'knowledge' && state.stats) renderKnowledgeMap();
  if (view === 'activity') loadActivity();
}

// -----------------------------------------------------------------------
// Search (top-level)
// -----------------------------------------------------------------------

const searchInput = document.getElementById('search-input');
let searchDebounce;
searchInput.addEventListener('input', () => {
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(() => {
    state.memFilter.q = searchInput.value.trim();
    state.memOffset = 0;
    state.memories = null;
    if (state.currentView !== 'memories') switchView('memories');
    else loadMemories();
  }, 280);
});

// -----------------------------------------------------------------------
// Refresh
// -----------------------------------------------------------------------

let _lastRefreshed = null;

function updateRefreshTimestamp() {
  _lastRefreshed = new Date();
  const el = document.getElementById('refresh-updated');
  if (el) el.textContent = 'just now';
}

function tickRefreshTimestamp() {
  const el = document.getElementById('refresh-updated');
  if (!el || !_lastRefreshed) return;
  const diffMin = Math.floor((new Date() - _lastRefreshed) / 60000);
  if (diffMin === 0) el.textContent = 'just now';
  else if (diffMin === 1) el.textContent = '1 min ago';
  else el.textContent = `${diffMin} min ago`;
}

setInterval(tickRefreshTimestamp, 60000);

document.getElementById('btn-refresh').addEventListener('click', async () => {
  const btn = document.getElementById('btn-refresh');
  btn.disabled = true;
  btn.style.opacity = '0.4';
  await fetch('/api/refresh', { method: 'POST' }).catch(() => {});
  state.stats = null;
  state.memories = null;
  state.sessions = null;
  await loadStats();
  if (state.currentView === 'memories') loadMemories();
  if (state.currentView === 'sessions') loadSessions();
  btn.disabled = false;
  btn.style.opacity = '';
  updateRefreshTimestamp();
});

// Project badge click ‚Üí filter memories by this project
document.querySelector('.project-badge').addEventListener('click', () => {
  const proj = document.getElementById('project-label').textContent;
  if (!proj || proj === '‚Äî') return;
  state.memFilter = { sort: state.memFilter.sort, domain: '', tag: '', q: '', session_id: '', action_required: '', min_importance: '', stale_days: '' };
  switchView('memories');
  loadMemories();
});

// -----------------------------------------------------------------------
// Stats / Overview
// -----------------------------------------------------------------------

async function loadStats() {
  const res = await fetch('/api/stats');
  const data = await res.json();
  state.stats = data;

  const project = data._project || '‚Äî';
  document.getElementById('project-label').textContent = data._project || data.memories?.total ? 'LFI' : '‚Äî';

  renderStatCards(data);
  renderGrades(data);
  renderDomainBars(data);
  renderHeatmap(data);
  renderDomainNav(data);

  const total = data.memories?.total ?? 0;
  const sessions = data.sessions?.total ?? 0;
  document.getElementById('overview-sub').textContent =
    `${total.toLocaleString()} memories across ${sessions.toLocaleString()} sessions`;
}

function renderStatCards(data) {
  const m = data.memories || {};
  const s = data.sessions || {};

  const cards = [
    { label: 'Total memories', value: (m.total ?? 0).toLocaleString(), cls: 'amber', sub: `avg importance ${(m.avg_importance ?? 0).toFixed(2)}`, action: 'memories', tooltip: 'View all memories' },
    { label: 'Sessions', value: (s.total ?? 0).toLocaleString(), cls: '', sub: `${(s.total_messages ?? 0).toLocaleString()} messages`, action: 'sessions', tooltip: 'View session history' },
    { label: 'Grade A memories', value: (m.grades?.A ?? 0).toLocaleString(), cls: 'green', sub: 'importance ‚â• 0.8', action: 'grade-a', tooltip: 'Filter to grade A memories (importance ‚â• 0.8)' },
    { label: 'Action items', value: (m.action_required ?? 0).toLocaleString(), cls: '', sub: `${m.problem_solution_pairs ?? 0} problem-solution pairs`, action: 'action-required', tooltip: 'Filter to memories requiring action' },
  ];

  const row = document.getElementById('stat-row');
  row.innerHTML = cards.map(c => `
    <div class="stat-card" data-action="${c.action}" data-tooltip="${c.tooltip}">
      <div class="stat-label">${c.label}</div>
      <div class="stat-value ${c.cls}">${c.value}</div>
      <div class="stat-sub">${c.sub}</div>
    </div>
  `).join('');

  // Wire up stat card clicks
  row.querySelectorAll('.stat-card[data-action]').forEach(card => {
    card.addEventListener('click', () => {
      const action = card.dataset.action;
      if (action === 'memories') {
        state.memFilter = { sort: 'importance', domain: '', tag: '', q: '', session_id: '', action_required: '', min_importance: '', stale_days: '' };
        state.memOffset = 0; state.memories = null;
        switchView('memories'); loadMemories();
      } else if (action === 'sessions') {
        switchView('sessions');
      } else if (action === 'grade-a') {
        filterByMinImportance(0.8);
      } else if (action === 'action-required') {
        filterByActionRequired();
      }
    });
  });
}

function renderGrades(data) {
  const grades = data.memories?.grades || {};
  const total = Object.values(grades).reduce((a, b) => a + b, 0);
  document.getElementById('grade-total').textContent = total.toLocaleString() + ' graded';

  const order = ['A', 'B', 'C', 'D'];
  const colors = { A: 'var(--green)', B: 'var(--amber)', C: '#6b7c72', D: 'var(--rose)' };

  const bar = document.getElementById('grade-bar');
  bar.innerHTML = order.map(g => {
    const count = grades[g] || 0;
    const pct = total ? (count / total * 100).toFixed(1) : 0;
    return `<div class="grade-seg ${g}" style="flex:${count};background:${colors[g]}" title="${g}: ${count} (${pct}%)"></div>`;
  }).join('');

  const legend = document.getElementById('grade-legend');
  legend.innerHTML = order.map(g => {
    const count = grades[g] || 0;
    const pct = total ? (count / total * 100).toFixed(0) : 0;
    return `<div class="grade-item"><div class="grade-dot" style="background:${colors[g]}"></div>${g} &nbsp;${count} (${pct}%)</div>`;
  }).join('');
}

function renderDomainBars(data) {
  // For overview, show top substantive domains (exclude meta-tags like learnings/universal)
  const allDomains = data.domains || {};
  const META_DOMAINS = new Set(['learnings', 'universal', 'promoted', '#learning', '#universal', '#promoted']);
  const substantiveDomains = Object.fromEntries(
    Object.entries(allDomains).filter(([k]) => !META_DOMAINS.has(k.toLowerCase()))
  );
  const contexts = data.context_types || {};
  renderBars('domain-bars', Object.keys(substantiveDomains).length > 0 ? substantiveDomains : allDomains, 8);
  renderBars('context-bars', contexts, 8);
}

function renderBars(containerId, obj, maxItems) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const entries = Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, maxItems);
  const max = entries[0]?.[1] || 1;
  el.innerHTML = entries.map(([label, count]) => `
    <div class="bar-item" data-domain="${label}" title="${label}: ${count}">
      <div class="bar-label">${label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/max*100).toFixed(1)}%"></div></div>
      <div class="bar-count">${count}</div>
    </div>
  `).join('') || '<div class="empty-state">No data yet</div>';

  // Click domain bar ‚Üí filter memories
  el.querySelectorAll('.bar-item[data-domain]').forEach(item => {
    item.addEventListener('click', () => {
      state.memFilter.domain = item.dataset.domain;
      state.memOffset = 0;
      state.memories = null;
      switchView('memories');
      setTimeout(() => {
        const domSel = document.getElementById('mem-domain');
        if (domSel) {
          for (let opt of domSel.options) {
            if (opt.value === item.dataset.domain) { opt.selected = true; break; }
          }
        }
      }, 100);
    });
  });
}

function renderHeatmap(data) {
  const activity = data.sessions?.activity_by_day || {};
  const today = new Date();
  const WEEKS = 26; // ~6 months
  const DAYS = 7;

  // Build 26 weeks √ó 7 days grid going back from today
  const start = new Date(today);
  start.setDate(start.getDate() - (WEEKS * 7 - 1));
  // Align to Monday
  const dow = start.getDay(); // 0=Sun
  start.setDate(start.getDate() - (dow === 0 ? 6 : dow - 1));

  const max = Math.max(1, ...Object.values(activity));

  const cols = [];
  let monthLabels = [];
  let lastMonth = -1;

  for (let w = 0; w < WEEKS; w++) {
    const cells = [];
    for (let d = 0; d < DAYS; d++) {
      const date = new Date(start);
      date.setDate(date.getDate() + w * 7 + d);
      const key = date.toISOString().slice(0, 10);
      const count = activity[key] || 0;

      // Track month headers
      if (d === 0 && date.getMonth() !== lastMonth) {
        monthLabels.push({ col: w, label: date.toLocaleDateString('en', { month: 'short' }) });
        lastMonth = date.getMonth();
      }

      let level = '';
      if (count > 0) {
        const ratio = count / max;
        if (ratio < 0.25) level = 'l1';
        else if (ratio < 0.5) level = 'l2';
        else if (ratio < 0.75) level = 'l3';
        else level = 'l4';
      }
      const clickable = count > 0 ? `data-date="${key}" style="cursor:pointer"` : '';
      cells.push(`<div class="heatmap-cell ${level}" title="${key}: ${count} session${count !== 1 ? 's' : ''}" ${clickable}></div>`);
    }
    cols.push(`<div class="heatmap-col">${cells.join('')}</div>`);
  }

  const grid = document.getElementById('heatmap-grid');
  grid.innerHTML = cols.join('');
  document.getElementById('heatmap-total').textContent =
    (data.sessions?.total ?? 0) + ' total sessions';

  // Heatmap day cells ‚Üí Sessions view filtered to that date
  grid.querySelectorAll('.heatmap-cell[data-date]').forEach(cell => {
    cell.addEventListener('click', () => {
      const date = cell.dataset.date;
      if (!date) return;
      state.sessionDateFilter = date;
      switchView('sessions');
      loadSessions(date);
    });
  });

  // Month labels ‚Äî approximate positioning
  const monthsEl = document.getElementById('heatmap-months');
  let html = '';
  for (let i = 0; i < monthLabels.length; i++) {
    const { col, label } = monthLabels[i];
    html += `<span style="width:${(col === 0 ? 0 : 15) + (i === 0 ? 0 : 0)}px"></span><span style="margin-right:${(15 * (monthLabels[i+1]?.col ?? WEEKS) - 15 * col) - label.length * 4}px">${label}</span>`;
  }
  monthsEl.innerHTML = monthLabels.map(({ col, label }) =>
    `<span style="padding-right:${Math.max(0, (col < 1 ? 20 : 15))}px">${label}</span>`
  ).join('');
}

function renderDomainNav(data) {
  const domains = data.domains || {};
  const nav = document.getElementById('domain-nav');
  const top = Object.entries(domains).sort((a, b) => b[1] - a[1]).slice(0, 8);

  nav.innerHTML = top.map(([d, count]) => `
    <div class="nav-item" data-filter-domain="${d}" style="font-size:12px;padding:7px 20px">
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d}</span>
      <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-3)">${count}</span>
    </div>
  `).join('');

  nav.querySelectorAll('[data-filter-domain]').forEach(el => {
    el.addEventListener('click', () => {
      state.memFilter.domain = el.dataset.filterDomain;
      state.memOffset = 0;
      state.memories = null;
      switchView('memories');
    });
  });
}

// -----------------------------------------------------------------------
// Memories
// -----------------------------------------------------------------------

let _loadingMemories = false;

async function loadMemories(append = false) {
  // Prevent concurrent loads clobbering each other
  if (_loadingMemories && !append) return;
  _loadingMemories = true;

  if (!append) {
    state.memories = null;
    document.getElementById('memory-list').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  }

  try {
    const params = new URLSearchParams({
      sort: state.memFilter.sort,
      domain: state.memFilter.domain,
      tag: state.memFilter.tag,
      q: state.memFilter.q,
      limit: state.MEM_PAGE,
      offset: state.memOffset,
    });
    if (state.memFilter.session_id) params.set('session_id', state.memFilter.session_id);
    if (state.memFilter.action_required) params.set('action_required', state.memFilter.action_required);
    if (state.memFilter.min_importance) params.set('min_importance', state.memFilter.min_importance);
    if (state.memFilter.stale_days) params.set('stale_days', state.memFilter.stale_days);

    const res = await fetch('/api/memories?' + params);
    if (!res.ok) throw new Error(`API error ${res.status}`);
    const data = await res.json();

    state.memories = state.memories || [];
    if (append) {
      state.memories = [...state.memories, ...data.memories];
    } else {
      state.memories = data.memories;
      state.memTotal = data.total;
    }

    renderMemories(data.total);
  } catch (err) {
    console.error('loadMemories failed:', err);
    document.getElementById('memory-list').innerHTML =
      `<div class="empty-state" style="color:var(--rose)">Failed to load memories: ${err.message}</div>`;
  } finally {
    _loadingMemories = false;
  }

  // Populate domain select once
  if (!append && state.stats) {
    const sel = document.getElementById('mem-domain');
    const existing = new Set(Array.from(sel.options).map(o => o.value));
    Object.keys(state.stats.domains || {}).forEach(d => {
      if (!existing.has(d)) {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        sel.appendChild(opt);
      }
    });
    if (state.memFilter.domain) sel.value = state.memFilter.domain;
  }
}

function renderMemories(total) {
  const list = document.getElementById('memory-list');
  const shown = state.memories?.length ?? 0;

  document.getElementById('mem-count').textContent = `${total} found`;
  document.getElementById('memories-sub').textContent =
    `Showing ${shown} of ${total} memories`;

  // Show/hide session filter chip
  const chip = document.getElementById('session-filter-chip');
  if (chip) chip.classList.toggle('active', !!state.memFilter.session_id);

  // Sync stale toggle visual
  const staleBtn = document.getElementById('stale-toggle');
  if (staleBtn) staleBtn.classList.toggle('active', !!state.memFilter.stale_days);

  if (!state.memories || state.memories.length === 0) {
    list.innerHTML = '<div class="empty-state">No memories match the current filters</div>';
    document.getElementById('load-more-btn').style.display = 'none';
    return;
  }

  const cards = state.memories.map(m => {
    const imp = m.importance ?? 0.5;
    const conf = m.confidence ?? 0.9;
    const grade = imp >= 0.8 ? 'A' : imp >= 0.6 ? 'B' : imp >= 0.4 ? 'C' : 'D';
    const gradeDesc = { A: 'A ‚Äî very important (‚â•0.8)', B: 'B ‚Äî important (‚â•0.6)', C: 'C ‚Äî moderate (‚â•0.4)', D: 'D ‚Äî low importance (<0.4)' }[grade];
    const gradeTooltip = `Grade ${gradeDesc}. Set at extraction based on how useful this memory is likely to be. Drives retrieval ranking.`;
    const confTooltip = `Confidence: ${conf.toFixed(2)}. How certain the system is this memory is accurate and stable. Starts at 0.9, rises with reinforcements, falls with contradictions.`;
    const impTooltip = `Importance: ${imp.toFixed(2)}. Raw 0‚Äì1 weight used to compute grade and rank memories in search results.`;

    const tags = (m.tags || []).slice(0, 5).map(t => {
      let ttip = '';
      if (t === '#learning' || t === 'learning') ttip = 'General-purpose learning. Most memories land here by default.';
      else if (t === '#promoted' || t === 'promoted') ttip = 'Promoted to global scope ‚Äî appeared across enough sessions to be universally relevant.';
      else if (t === '#universal' || t === 'universal') ttip = 'Universal scope ‚Äî applies across all projects.';
      else if (t === '#action' || t === 'action') ttip = 'Action required ‚Äî this memory flags something to do.';
      return `<span class="mem-tag" data-tag="${t}"${ttip ? ` data-tooltip="${ttip}"` : ''}>${t}</span>`;
    }).join('');

    const date = m.created
      ? new Date(m.created).toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' })
      : '';

    const pills = [
      m.action_required ? '<span class="action-pill" data-tooltip="This memory has an associated action item.">action</span>' : '',
      m.problem_solution ? '<span class="ps-pill" data-tooltip="This memory is a question + answer pair.">Q+A</span>' : '',
    ].join('');

    // Search match display ‚Äî snippet with highlighted term, plus match reasons
    const activeQ = state.memFilter.q || '';
    const previewHtml = (activeQ && m.match_snippet)
      ? highlightQuery(m.match_snippet, activeQ)
      : escHtml(m.preview);
    const matchReasonsHtml = (activeQ && m.match_reasons && m.match_reasons.length)
      ? `<div class="match-reasons">${m.match_reasons.map(r => `<span class="match-reason-tag" data-tooltip="This memory matched your search via its ${r}">matched via ${escHtml(r)}</span>`).join('')}</div>`
      : '';

    // Freshness indicator
    const ds = m.days_stale;
    const staleClass = ds == null ? '' : ds >= 180 ? ' stale-3' : ds >= 90 ? ' stale-2' : ds >= 30 ? ' stale-1' : '';
    const freshCls = ds == null ? 'fresh' : ds < 7 ? 'fresh' : ds < 30 ? 'recent' : ds < 90 ? 'aging' : 'stale';
    const freshLabel = ds == null ? '' : ds === 0 ? 'today' : ds === 1 ? '1 day ago' : `${ds}d ago`;
    const freshTooltip = ds == null ? '' : `Last updated ${freshLabel}. ${ds >= 90 ? 'Consider reviewing ‚Äî this memory may be outdated.' : ''}`;

    return `
      <div class="memory-card grade-${grade}${staleClass}" data-memory-id="${escHtml(m.id)}">
        <div class="memory-card-top">
          <div class="memory-preview">${previewHtml}${matchReasonsHtml}</div>
          <div class="importance-badge">
            <span class="imp-pip" data-tooltip="${escHtml(impTooltip)}"></span>
            <span class="imp-label" data-tooltip="${escHtml(gradeTooltip)}">${grade} ¬∑ ${imp.toFixed(2)}</span>
          </div>
        </div>
        <div class="memory-meta">
          ${m.knowledge_domain ? `<span class="mem-domain" data-tooltip="Domain: how this memory is categorized for filtering.">${escHtml(m.knowledge_domain)}</span>` : ''}
          ${tags}
          ${pills}
          ${conf < 0.75 ? `<span class="mem-tag" style="color:var(--rose)" data-tooltip="${escHtml(confTooltip)}">conf ${conf.toFixed(2)}</span>` : ''}
          ${freshLabel ? `<span class="mem-date" data-tooltip="${escHtml(freshTooltip)}"><span class="freshness-pip ${freshCls}"></span>${freshLabel}</span>` : (date ? `<span class="mem-date">${date}</span>` : '')}
        </div>
      </div>
    `;
  }).join('');

  list.innerHTML = cards;

  // Tag click ‚Üí filter
  list.querySelectorAll('.mem-tag[data-tag]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      state.memFilter.tag = el.dataset.tag;
      state.memOffset = 0;
      state.memories = null;
      loadMemories();
    });
  });

  // Card click ‚Üí open detail modal
  list.querySelectorAll('.memory-card[data-memory-id]').forEach(el => {
    el.addEventListener('click', () => {
      openMemoryModal(el.dataset.memoryId);
    });
  });

  const loadMoreBtn = document.getElementById('load-more-btn');
  if (shown < total) {
    loadMoreBtn.style.display = 'block';
    loadMoreBtn.textContent = `Load more (${total - shown} remaining)`;
  } else {
    loadMoreBtn.style.display = 'none';
  }
}

document.getElementById('load-more-btn').addEventListener('click', () => {
  state.memOffset += state.MEM_PAGE;
  loadMemories(true);
});

document.getElementById('session-filter-clear').addEventListener('click', () => {
  state.memFilter.session_id = '';
  state.memOffset = 0;
  state.memories = null;
  loadMemories();
});

document.getElementById('mem-sort').addEventListener('change', e => {
  state.memFilter.sort = e.target.value;
  state.memOffset = 0;
  state.memories = null;
  loadMemories();
});

document.getElementById('mem-domain').addEventListener('change', e => {
  state.memFilter.domain = e.target.value;
  state.memOffset = 0;
  state.memories = null;
  loadMemories();
});

document.getElementById('stale-toggle').addEventListener('click', () => {
  const btn = document.getElementById('stale-toggle');
  const isActive = btn.classList.toggle('active');
  state.memFilter.stale_days = isActive ? '90' : '';
  state.memOffset = 0;
  state.memories = null;
  loadMemories();
});

// -----------------------------------------------------------------------
// Sessions
// -----------------------------------------------------------------------

async function loadSessions(dateFilter) {
  const params = new URLSearchParams({ limit: 200 });
  if (dateFilter) params.set('date', dateFilter);
  const res = await fetch('/api/sessions?' + params);
  const data = await res.json();
  state.sessions = data.sessions;

  document.getElementById('sessions-sub').textContent =
    dateFilter
      ? `${data.total.toLocaleString()} sessions on ${dateFilter}`
      : `${data.total.toLocaleString()} sessions total`;

  const list = document.getElementById('session-list');

  if (!data.sessions.length) {
    list.innerHTML = '<div class="empty-state">No sessions found</div>';
    return;
  }

  list.innerHTML = data.sessions.map(s => {
    const dt = s.datetime ? new Date(s.datetime) : null;
    const dateStr = dt ? dt.toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî';
    const timeStr = dt ? dt.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' }) : '';
    const name = s.name || s.id || 'Untitled session';
    const mems = s.memories_extracted;
    const sid = s.id || '';
    const memTitle = mems > 0 ? `Click to see ${mems} memories from this session` : '';

    return `
      <div class="session-row" data-session-id="${escHtml(sid)}" title="${escHtml(memTitle || 'View memories from this session')}">
        <div class="sess-date">${dateStr}<br><span style="color:var(--text-3)">${timeStr}</span></div>
        <div class="sess-name" title="${escHtml(name)}">${escHtml(name)}</div>
        <div class="sess-stat">${s.message_count}</div>
        <div class="sess-stat">${s.tool_call_count}</div>
        <div class="sess-stat ${mems > 0 ? 'amber' : ''}">${mems > 0 ? mems : '‚Äî'}</div>
      </div>
    `;
  }).join('');

  // Click row ‚Üí filter memories by session
  list.querySelectorAll('.session-row[data-session-id]').forEach(row => {
    row.addEventListener('click', () => {
      const sid = row.dataset.sessionId;
      if (sid) filterBySession(sid);
    });
  });
}

// -----------------------------------------------------------------------
// Knowledge map
// -----------------------------------------------------------------------

function renderKnowledgeMap() {
  if (!state.stats) return;

  const tags = state.stats.tags || {};
  const entries = Object.entries(tags).sort((a, b) => b[1] - a[1]);
  const max = entries[0]?.[1] || 1;

  document.getElementById('tag-count').textContent = entries.length + ' unique tags';

  // Color palette for tags
  const palettes = [
    { bg: 'rgba(212,134,42,0.15)', border: 'rgba(212,134,42,0.4)', text: '#d4862a' },
    { bg: 'rgba(61,184,122,0.12)', border: 'rgba(61,184,122,0.35)', text: '#3db87a' },
    { bg: 'rgba(58,138,184,0.12)', border: 'rgba(58,138,184,0.35)', text: '#3a8ab8' },
    { bg: 'rgba(192,81,106,0.1)', border: 'rgba(192,81,106,0.3)', text: '#c0516a' },
    { bg: 'rgba(154,110,94,0.12)', border: 'rgba(154,110,94,0.35)', text: '#9a6e5e' },
  ];

  const cloud = document.getElementById('tag-cloud');
  cloud.innerHTML = entries.map(([tag, count], i) => {
    const size = 11 + Math.round((count / max) * 10); // 11‚Äì21px
    const pal = palettes[i % palettes.length];
    return `<div class="tag-bubble" style="font-size:${size}px;background:${pal.bg};border-color:${pal.border};color:${pal.text}"
      data-tag="${tag}" title="${count} memories">${tag} <sup style="font-size:0.7em;opacity:0.7">${count}</sup></div>`;
  }).join('');

  cloud.querySelectorAll('.tag-bubble[data-tag]').forEach(el => {
    el.addEventListener('click', () => {
      state.memFilter.tag = el.dataset.tag;
      state.memOffset = 0;
      state.memories = null;
      switchView('memories');
    });
  });

  // Domain breakdown: split meta-tags (learnings/universal/promoted) from substantive domains
  const allDomains = state.stats.domains || {};
  const META_DOMAINS = new Set(['learnings', 'universal', 'promoted', '#learning', '#universal', '#promoted']);
  const substantive = {};
  const meta = {};
  for (const [k, v] of Object.entries(allDomains)) {
    if (META_DOMAINS.has(k.toLowerCase())) meta[k] = v;
    else substantive[k] = v;
  }

  const fullEl = document.getElementById('domain-bars-full');
  if (fullEl) {
    let html = '';
    // Substantive domains first
    if (Object.keys(substantive).length > 0) {
      html += `<div style="font-family:var(--font-mono);font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px">Substantive domains</div>`;
      html += renderBarsHtml(substantive, 20);
    }
    // Meta-tags at bottom, de-emphasized
    if (Object.keys(meta).length > 0) {
      html += `<div style="font-family:var(--font-mono);font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.08em;margin:16px 0 8px;border-top:1px solid var(--border);padding-top:12px">Default / system tags</div>`;
      html += renderBarsHtml(meta, 5, 0.4); // dimmed opacity
    }
    fullEl.innerHTML = html;

    // Make domain bars clickable
    fullEl.querySelectorAll('.bar-row[data-domain]').forEach(row => {
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => {
        state.memFilter.domain = row.dataset.domain;
        state.memOffset = 0;
        state.memories = null;
        switchView('memories');
        loadMemories();
      });
    });
  }
}

// Return bar HTML for a domain map (used in knowledge map and overview)
function renderBarsHtml(domains, maxItems = 20, opacity = 1) {
  const entries = Object.entries(domains).sort((a, b) => b[1] - a[1]).slice(0, maxItems);
  const maxVal = entries[0]?.[1] || 1;
  return entries.map(([domain, count]) => {
    const pct = Math.max(3, Math.round((count / maxVal) * 100));
    return `<div class="bar-row" data-domain="${escHtml(domain)}" style="opacity:${opacity}" title="${count} memories ¬∑ click to filter">
      <span class="bar-label">${escHtml(domain)}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
      <span class="bar-count">${count}</span>
    </div>`;
  }).join('');
}

// -----------------------------------------------------------------------
// Utility
// -----------------------------------------------------------------------

function escHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

/** Escape str for HTML, then wrap occurrences of query in <mark>. */
function highlightQuery(str, query) {
  if (!str) return '';
  const escaped = escHtml(str);
  if (!query) return escaped;
  const escapedQ = escHtml(query);
  // Case-insensitive replace with <mark>
  const re = new RegExp(escapedQ.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
  return escaped.replace(re, m => `<mark>${m}</mark>`);
}

// -----------------------------------------------------------------------
// Memory detail modal
// -----------------------------------------------------------------------

const modal = document.getElementById('memory-modal');
const modalBody = document.getElementById('modal-body');
const modalTitle = document.getElementById('modal-title');

document.getElementById('modal-close').addEventListener('click', closeModal);
modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function closeModal() {
  modal.classList.remove('open');
}

async function openMemoryModal(memoryId) {
  modal.classList.add('open');
  modalBody.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  modalTitle.textContent = 'Loading‚Ä¶';

  try {
    const res = await fetch(`/api/memory/${encodeURIComponent(memoryId)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const m = await res.json();
    if (m.error) throw new Error(m.error);

    const imp = m.importance ?? 0.5;
    const grade = imp >= 0.8 ? 'A' : imp >= 0.6 ? 'B' : imp >= 0.4 ? 'C' : 'D';
    const gradeColors = { A: 'var(--green)', B: 'var(--amber)', C: '#6b7c72', D: 'var(--rose)' };

    const created = m.created ? new Date(m.created).toLocaleDateString('en', { month: 'long', day: 'numeric', year: 'numeric' }) : '‚Äî';
    const updated = m.updated ? new Date(m.updated).toLocaleDateString('en', { month: 'long', day: 'numeric', year: 'numeric' }) : '‚Äî';

    modalTitle.innerHTML = `<span style="color:${gradeColors[grade]}">‚óè</span> ${escHtml(m.knowledge_domain || 'Memory')} <span style="color:var(--text-3);font-size:12px;font-family:var(--font-mono)">${grade} ¬∑ ${imp.toFixed(2)}</span>`;

    const tags = (m.tags || []).map(t => `<span class="mem-tag">${escHtml(t)}</span>`).join('');

    const pills = [
      m.action_required ? '<span class="action-pill">action required</span>' : '',
      m.problem_solution ? '<span class="ps-pill">problem-solution pair</span>' : '',
    ].filter(Boolean).join(' ');

    modalBody.innerHTML = `
      <div class="modal-meta-grid">
        <div class="modal-meta-item">
          <div class="modal-meta-label">Grade</div>
          <div class="modal-meta-value" style="color:${gradeColors[grade]}">${grade} (${imp.toFixed(2)})</div>
        </div>
        <div class="modal-meta-item">
          <div class="modal-meta-label">Confidence</div>
          <div class="modal-meta-value">${(m.confidence ?? 0).toFixed(2)}</div>
        </div>
        <div class="modal-meta-item">
          <div class="modal-meta-label">Domain</div>
          <div class="modal-meta-value">${escHtml(m.knowledge_domain)}</div>
        </div>
        <div class="modal-meta-item">
          <div class="modal-meta-label">Type</div>
          <div class="modal-meta-value">${escHtml(m.context_type)}</div>
        </div>
        <div class="modal-meta-item">
          <div class="modal-meta-label">Created</div>
          <div class="modal-meta-value">${created}</div>
        </div>
        <div class="modal-meta-item">
          <div class="modal-meta-label">Updated</div>
          <div class="modal-meta-value">${updated}</div>
        </div>
      </div>
      ${pills ? `<div style="margin-bottom:16px">${pills}</div>` : ''}
      <div class="modal-body-content">${escHtml(m.body)}</div>
      ${tags ? `<div class="modal-tags">${tags}</div>` : ''}
      ${m.filename ? `<div style="margin-top:12px;font-family:var(--font-mono);font-size:10px;color:var(--text-3)">File: ${escHtml(m.filename)}</div>` : ''}
    `;
  } catch (err) {
    modalBody.innerHTML = `<div class="empty-state" style="color:var(--rose)">Failed to load memory: ${err.message}</div>`;
    modalTitle.textContent = 'Error';
  }
}

// -----------------------------------------------------------------------
// Export
// -----------------------------------------------------------------------

document.getElementById('export-json').addEventListener('click', () => {
  window.open('/api/export?format=json', '_blank');
});

document.getElementById('export-csv').addEventListener('click', () => {
  window.open('/api/export?format=csv', '_blank');
});

// -----------------------------------------------------------------------
// Notification center
// -----------------------------------------------------------------------

const NOTIF_ICONS = {
  consolidation_summary:  { emoji: '\u{1f4be}', cls: 'consolidation' },
  memory_promoted:        { emoji: '\u2b06\ufe0f', cls: 'promotion' },
  reinforcement_detected: { emoji: '\u{1f501}', cls: 'reinforcement' },
  contradiction:          { emoji: '\u26a0\ufe0f', cls: 'contradiction' },
  pattern_detected:       { emoji: '\u{1f50d}', cls: 'default' },
  quality_issue:          { emoji: '\u{1f4ca}', cls: 'default' },
  expiring_memory:        { emoji: '\u23f0',    cls: 'default' },
  stale_memory:           { emoji: '\u{1f4a4}', cls: 'default' },
};

// Human-readable labels for alert types (used in chips)
const ALERT_LABELS = {
  consolidation_summary:  'session recap',
  memory_promoted:        'promoted',
  reinforcement_detected: 'reinforced',
  contradiction:          'contradiction',
  pattern_detected:       'pattern',
  quality_issue:          'quality',
  expiring_memory:        'expiring',
  stale_memory:           'stale',
};

function relativeTime(isoStr) {
  if (!isoStr) return '';
  const date = new Date(isoStr);
  const now = new Date();
  const diffSec = Math.floor((now - date) / 1000);
  if (diffSec < 60) return 'just now';
  const diffMin = Math.floor(diffSec / 60);
  if (diffMin < 60) return `${diffMin}m ago`;
  const diffHr = Math.floor(diffMin / 60);
  if (diffHr < 24) return `${diffHr}h ago`;
  const diffDay = Math.floor(diffHr / 24);
  if (diffDay < 7) return `${diffDay}d ago`;
  return date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
}

// --- Bell badge + dropdown ---

let notifDropdownOpen = false;

document.getElementById('btn-bell').addEventListener('click', (e) => {
  e.stopPropagation();
  const dd = document.getElementById('notif-dropdown');
  notifDropdownOpen = !notifDropdownOpen;
  dd.classList.toggle('open', notifDropdownOpen);
  if (notifDropdownOpen) loadNotifDropdown();
});

document.addEventListener('click', (e) => {
  if (notifDropdownOpen && !document.getElementById('notif-wrap').contains(e.target)) {
    notifDropdownOpen = false;
    document.getElementById('notif-dropdown').classList.remove('open');
  }
});

async function pollNotifications() {
  try {
    const res = await fetch('/api/notifications?limit=8');
    if (!res.ok) return;
    const data = await res.json();

    const badge = document.getElementById('notif-badge');
    const count = data.unread_count || 0;
    badge.textContent = count > 99 ? '99+' : count;
    badge.classList.toggle('hidden', count === 0);

    const navBadge = document.getElementById('activity-nav-badge');
    if (navBadge) {
      navBadge.textContent = count;
      navBadge.style.display = count > 0 ? 'inline' : 'none';
    }
  } catch (e) {
    // Silent fail for poll
  }
}

async function loadNotifDropdown() {
  const list = document.getElementById('notif-dropdown-list');
  try {
    const res = await fetch('/api/notifications?limit=8');
    const data = await res.json();
    const items = data.notifications || [];

    if (items.length === 0) {
      list.innerHTML = '<div class="notif-empty">No new notifications</div>';
      return;
    }

    list.innerHTML = items.map(n => {
      const icon = NOTIF_ICONS[n.alert_type] || { emoji: '\u{1f514}', cls: 'default' };
      return `
        <div class="notif-item" data-notif-id="${n.alert_id}">
          <div class="notif-icon ${icon.cls}">${icon.emoji}</div>
          <div class="notif-content">
            <div class="notif-title-text">${escHtml(n.title)}</div>
            <div class="notif-time">${relativeTime(n.created_at)}</div>
          </div>
          <button class="notif-dismiss-btn" data-dismiss-id="${n.alert_id}" title="Dismiss">&times;</button>
        </div>
      `;
    }).join('');

    list.querySelectorAll('.notif-dismiss-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = btn.dataset.dismissId;
        await fetch(`/api/notifications/${id}/dismiss`, { method: 'POST' });
        btn.closest('.notif-item').remove();
        pollNotifications();
        if (!list.querySelector('.notif-item')) {
          list.innerHTML = '<div class="notif-empty">No new notifications</div>';
        }
      });
    });

    list.querySelectorAll('.notif-item').forEach(item => {
      item.addEventListener('click', () => {
        notifDropdownOpen = false;
        document.getElementById('notif-dropdown').classList.remove('open');
        switchView('activity');
      });
    });
  } catch (e) {
    list.innerHTML = '<div class="notif-empty" style="color:var(--rose)">Failed to load</div>';
  }
}

document.getElementById('notif-mark-all-read').addEventListener('click', async (e) => {
  e.stopPropagation();
  await fetch('/api/notifications/dismiss-all', { method: 'POST' });
  document.getElementById('notif-dropdown-list').innerHTML =
    '<div class="notif-empty">No new notifications</div>';
  pollNotifications();
});

document.getElementById('notif-header-link').addEventListener('click', () => {
  notifDropdownOpen = false;
  document.getElementById('notif-dropdown').classList.remove('open');
  switchView('activity');
});

// Make entire dropdown header clickable (except mark-all-read button)
document.querySelector('.notif-dropdown-header').addEventListener('click', e => {
  if (e.target.closest('#notif-mark-all-read')) return; // let mark-all-read handle itself
  notifDropdownOpen = false;
  document.getElementById('notif-dropdown').classList.remove('open');
  switchView('activity');
});

document.getElementById('notif-view-all').addEventListener('click', () => {
  notifDropdownOpen = false;
  document.getElementById('notif-dropdown').classList.remove('open');
  switchView('activity');
});

// Filter memories by session ID (used from activity cards and session rows)
function filterBySession(sessionId) {
  if (!sessionId) return;
  state.memFilter = { sort: state.memFilter.sort, domain: '', tag: '', q: '', session_id: sessionId, action_required: '', min_importance: '', stale_days: '' };
  switchView('memories');
  loadMemories();
}

function filterByActionRequired() {
  state.memFilter = { sort: state.memFilter.sort, domain: '', tag: '', q: '', session_id: '', action_required: 'true', min_importance: '', stale_days: '' };
  state.memOffset = 0;
  state.memories = null;
  switchView('memories');
  loadMemories();
}

function filterByMinImportance(threshold) {
  state.memFilter = { sort: 'importance', domain: '', tag: '', q: '', session_id: '', action_required: '', min_importance: String(threshold), stale_days: '' };
  state.memOffset = 0;
  state.memories = null;
  switchView('memories');
  loadMemories();
}

// Poll every 30 seconds
setInterval(pollNotifications, 30000);

// -----------------------------------------------------------------------
// Activity view
// -----------------------------------------------------------------------

let activityState = { items: null, total: 0, offset: 0, PAGE: 40 };

async function loadActivity(append = false) {
  if (!append) {
    activityState.items = null;
    activityState.offset = 0;
    document.getElementById('activity-list').innerHTML =
      '<div class="loading-state"><div class="spinner"></div></div>';
  }

  const typeFilter = document.getElementById('activity-type-filter').value;
  const params = new URLSearchParams({
    limit: activityState.PAGE,
    offset: activityState.offset,
  });
  if (typeFilter) params.set('type', typeFilter);

  try {
    const res = await fetch('/api/notifications/all?' + params);
    const data = await res.json();

    activityState.total = data.total;
    const newItems = data.notifications || [];

    if (append) {
      activityState.items = [...(activityState.items || []), ...newItems];
    } else {
      activityState.items = newItems;
    }

    renderActivity();
  } catch (e) {
    document.getElementById('activity-list').innerHTML =
      `<div class="empty-state" style="color:var(--rose)">Failed: ${e.message}</div>`;
  }
}

function renderActivity() {
  const items = activityState.items || [];
  const list = document.getElementById('activity-list');

  document.getElementById('activity-count').textContent = activityState.total + ' total';
  document.getElementById('activity-sub').textContent =
    `Showing ${items.length} of ${activityState.total} events`;

  if (items.length === 0) {
    list.innerHTML = '<div class="empty-state">No activity yet. Consolidation events will appear here after sessions end.</div>';
    document.getElementById('activity-load-more').style.display = 'none';
    return;
  }

  // Render content section (saved/reinforced/promoted memory previews)
  function contentSection(label, previews, cardId, sectionKey) {
    if (!previews || previews.length === 0) return '';
    const MAX_DEFAULT = 3;
    const allPreviews = previews;
    const shown = allPreviews.slice(0, MAX_DEFAULT);
    const more = allPreviews.length - shown.length;
    const itemsHtml = shown.map(p => `<li>${escHtml(p)}</li>`).join('');
    const moreHtml = more > 0
      ? `<li class="activity-content-more">
           <button class="btn-expand-more" data-card="${cardId}" data-section="${sectionKey}" data-all="${escHtml(JSON.stringify(allPreviews))}">+ ${more} more</button>
         </li>`
      : '';
    return `<div class="activity-content-section" data-section-id="${cardId}-${sectionKey}">
      <span class="activity-content-label">${label}</span>
      <ul class="activity-content-list">${itemsHtml}${moreHtml}</ul>
    </div>`;
  }

  // Strip markdown formatting for plain-text display
  function stripMd(s) {
    return String(s || '')
      .replace(/\*\*(.+?)\*\*/g, '$1')
      .replace(/\*(.+?)\*/g, '$1')
      .replace(/^#+\s+/gm, '')
      .replace(/^[-*]\s+/gm, '')
      .replace(/\s+/g, ' ').trim();
  }

  // Derive semantic title from memory content
  function semanticTitle(n) {
    const meta = n.metadata || {};
    const savedPreviews = meta.saved_previews || [];
    const reinforcedPreviews = meta.reinforced_previews || [];
    // Use first preview truncated ‚Äî actual content, not system jargon
    if (savedPreviews.length > 0) {
      const clean = stripMd(savedPreviews[0].replace(/\s*\(\d+\.\d+\)$/, ''));
      return clean.slice(0, 72).replace(/\s+$/, '') + (clean.length > 72 ? '‚Ä¶' : '');
    }
    if (reinforcedPreviews.length > 0) {
      const clean = stripMd(reinforcedPreviews[0]);
      return clean.slice(0, 72).replace(/\s+$/, '') + (clean.length > 72 ? '‚Ä¶' : '');
    }
    // Fallback: use the stored title
    return n.title;
  }

  // Count summary as secondary metadata
  function countSummary(meta) {
    const parts = [];
    if (meta.memories_saved) parts.push(`${meta.memories_saved} saved`);
    if (meta.reinforcements) parts.push(`${meta.reinforcements} reinforced`);
    if (meta.promotions) parts.push(`${meta.promotions} promoted`);
    if (meta.count && !meta.memories_saved) parts.push(`√ó${meta.count}`);
    return parts.join(' ¬∑ ');
  }

  list.innerHTML = items.map(n => {
    const icon = NOTIF_ICONS[n.alert_type] || { emoji: '\u{1f514}', cls: 'default' };
    const dismissed = n.dismissed_at ? ' dismissed' : '';
    const meta = n.metadata || {};
    const typeIcon = icon.emoji;
    const typeLabel = ALERT_LABELS[n.alert_type] || n.alert_type.replace(/_/g, ' ');
    const summary = countSummary(meta);
    const sessionId = meta.session_id || '';

    const contentHtml =
      contentSection('Saved', meta.saved_previews, n.alert_id, 'saved') +
      contentSection('Reinforced', meta.reinforced_previews, n.alert_id, 'reinforced') +
      contentSection('Promoted', meta.promoted_previews, n.alert_id, 'promoted');

    const clickable = sessionId ? ` style="cursor:pointer" title="Show memories from this session"` : '';

    return `
      <div class="activity-card${dismissed}" data-activity-id="${n.alert_id}" data-session-id="${escHtml(sessionId)}"${clickable}>
        <div class="activity-card-icon ${icon.cls}">${icon.emoji}</div>
        <div class="activity-card-body">
          <div class="activity-card-title">${escHtml(semanticTitle(n))}</div>
          <div class="activity-card-meta">
            <span class="activity-card-time">${relativeTime(n.created_at)}</span>
            <span class="activity-card-type">${typeIcon} ${typeLabel}</span>
            ${summary ? `<span class="activity-card-type" style="color:var(--text-3)">${escHtml(summary)}</span>` : ''}
          </div>
          ${contentHtml}
        </div>
        ${!n.dismissed_at ? `
          <div class="activity-card-actions">
            <button class="btn-dismiss-activity" data-dismiss-id="${n.alert_id}">Dismiss</button>
          </div>
        ` : ''}
      </div>
    `;
  }).join('');

  // Dismiss buttons
  list.querySelectorAll('.btn-dismiss-activity').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.dataset.dismissId;
      await fetch(`/api/notifications/${id}/dismiss`, { method: 'POST' });
      btn.closest('.activity-card').classList.add('dismissed');
      btn.remove();
      pollNotifications();
    });
  });

  // Card click ‚Üí filter memories by session
  list.querySelectorAll('.activity-card[data-session-id]').forEach(card => {
    const sid = card.dataset.sessionId;
    if (!sid) return;
    card.addEventListener('click', (e) => {
      // Don't intercept dismiss or expand clicks
      if (e.target.closest('.btn-dismiss-activity') || e.target.closest('.btn-expand-more')) return;
      filterBySession(sid);
    });
  });

  // "+ N more" expand in place
  list.querySelectorAll('.btn-expand-more').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const all = JSON.parse(btn.dataset.all || '[]');
      const sectionEl = document.querySelector(`[data-section-id="${btn.dataset.card}-${btn.dataset.section}"]`);
      if (!sectionEl) return;
      const ul = sectionEl.querySelector('.activity-content-list');
      ul.innerHTML = all.map(p => `<li>${escHtml(p)}</li>`).join('');
    });
  });

  const loadMoreBtn = document.getElementById('activity-load-more');
  if (items.length < activityState.total) {
    loadMoreBtn.style.display = 'block';
    loadMoreBtn.textContent = `Load more (${activityState.total - items.length} remaining)`;
  } else {
    loadMoreBtn.style.display = 'none';
  }
}

document.getElementById('activity-load-more').addEventListener('click', () => {
  activityState.offset += activityState.PAGE;
  loadActivity(true);
});

document.getElementById('activity-type-filter').addEventListener('change', () => {
  loadActivity();
});

document.getElementById('activity-dismiss-all').addEventListener('click', async () => {
  await fetch('/api/notifications/dismiss-all', { method: 'POST' });
  loadActivity();
  pollNotifications();
});

// -----------------------------------------------------------------------
// Boot
// -----------------------------------------------------------------------

(async () => {
  try {
    await loadStats();
    const project = state.stats?._project;
    if (project) document.getElementById('project-label').textContent = project;
    // Pre-load memories so Memories tab is instant ‚Äî guard prevents race
    setTimeout(loadMemories, 800);

    // Initial notification poll
    pollNotifications();

    // Deep-link: handle ?view=activity from macOS notification
    const urlParams = new URLSearchParams(window.location.search);
    const viewParam = urlParams.get('view');
    if (viewParam && document.getElementById(`view-${viewParam}`)) {
      switchView(viewParam);
    }
  } catch (err) {
    console.error('Total Recall boot error:', err);
    document.getElementById('stat-row').innerHTML =
      `<div class="empty-state" style="color:var(--rose);padding:20px">
        Failed to load data from server.<br>
        <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-3)">${err.message}</span><br><br>
        Is <code>python3 dashboard/server.py</code> running?
      </div>`;
  }
})();
</script>
</body>
</html>
